 <h2> Title: Ruby: What does the comment &quot;frozen_string_literal: true&quot; do? </h2> <h4> messanjah, question_id: 37799296 </h4>Score: 404, Tags: {ruby} <br><p>This is the <code>rspec</code> binstub in my project directory.</p>

<pre><code>#!/usr/bin/env ruby
begin
  load File.expand_path("../spring", __FILE__)
rescue LoadError
end
# frozen_string_literal: true
#
# This file was generated by Bundler.
#
# The application 'rspec' is installed as part of a gem, and
# this file is here to facilitate running it.
#

require "pathname"
ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../../Gemfile",
  Pathname.new(__FILE__).realpath)

require "rubygems"
require "bundler/setup"

load Gem.bin_path("rspec-core", "rspec")
</code></pre>

<p>What is this intended to do?</p>

<pre><code># frozen_string_literal: true
</code></pre>
------------------------------------------------------------------ <br><h3> Dave Schweisguth, Id: 37799399, Score: 525: </h3><p><code># frozen_string_literal: true</code> is a magic comment, supported for the first time in Ruby 2.3, that tells Ruby that all string literals in the file are implicitly frozen, as if <code>#freeze</code> had been called on each of them. That is, if a string literal is defined in a file with this comment, and you call a method on that string which modifies it, such as <code>&lt;&lt;</code>, you'll get <code>RuntimeError: can't modify frozen String</code>.</p>
<p>Freezing strings prevents bugs caused by accidentally modifying a string when you didn't intend to, and may improve performance.</p>
<p><a href="https://docs.ruby-lang.org/en/3.1/syntax/comments_rdoc.html#label-Magic+Comments" rel="noreferrer">Like any magic comment, the frozen_string_literal comment must be in the first comment section of the file.</a> Ironically, the frozen_string_literal comment in that binstub is not in the binstub's first comment section and will be ignored.</p>
<p>In Ruby 2.3, you can use this magic comment <s>to prepare for frozen string literals being the default in Ruby 3</s>.</p>
<p>In Ruby 2.3 run with the <code>--enable=frozen-string-literal</code> flag, <s>and in Ruby 3, </s>string literals are frozen in all files. You can override the global setting with <code># frozen_string_literal: false</code>.</p>
<p>If you want a string literal to be mutable regardless of the global or per-file setting, you can prefix it with the unary <code>+</code> operator (being careful with operator precedence) or call <code>.dup</code> on it:</p>
<pre><code># frozen_string_literal: true
&quot;&quot;.frozen?
=&gt; true
(+&quot;&quot;).frozen?
=&gt; false
&quot;&quot;.dup.frozen?
=&gt; false
</code></pre>
<p>You can also freeze a mutable (unfrozen) string with unary <code>-</code>.</p>
<p><a href="https://github.com/ruby/ruby/blob/v3_0_0/parse.y#L8085-L8094" rel="noreferrer">Source: magic_comment defined in ruby/ruby</a></p>
<h4> Andres, Comment 76642851 Score: 55: </h4>Important thing to notice regarding freezing strings is that it <a href="https://bugs.ruby-lang.org/issues/8976#note-30" rel="nofollow noreferrer">improves app&#39;s performance</a>. See also <a href="https://www.lucascaton.com.br/2016/01/19/what-is-frozen_string_literal-in-ruby/" rel="nofollow noreferrer">here</a><br><h4> Konstantin Tikhonov, Comment 98975628 Score: 22: </h4>While you still can use the magic comment, Matz officially decided not to make all string literals immutable by default in Ruby 3: <a href="https://bugs.ruby-lang.org/issues/11473#note-53" rel="nofollow noreferrer">bugs.ruby-lang.org/issues/11473#note-53</a><br><h4> eregon, Comment 85058384 Score: 4: </h4><code>-</code> is for deduplicating the String to save memory, in addition to returning a frozen String.<br><h4> lilole, Comment 78407549 Score: 0: </h4>I wonder if this function is the issue, it seems to only be called with the unary minus. <a href="https://github.com/ruby/ruby/blob/trunk/string.c#L2572" rel="nofollow noreferrer">github.com/ruby/ruby/blob/trunk/string.c#L2572</a><br><h4> ggorlen, Comment 132209732 Score: 3: </h4>@Eddie because most languages treat strings as immutable, which helps ensure you don&#39;t accidentally modify them and can improve performance. Fewer state changes in a program mean less complexity. It&#39;s better to opt-in to mutability after careful consideration rather than making everything mutable by default. <a href="https://stackoverflow.com/questions/622664/what-is-immutability-and-why-should-i-worry-about-it">What is immutability and why should I worry about it?</a> may help.<br><h4> lilole, Comment 78406381 Score: 2: </h4>@dave-schweisguth Shouldn&#39;t we expect <code>-&quot;foo&quot;</code> to be the same as <code>&quot;foo&quot;.freeze</code>? When I check <code>(-&quot;foo&quot;).__id__</code> I get a different value each time, but <code>&quot;foo&quot;.freeze.__id__</code> is same each time. Any ideas?<br><h4> Eddie, Comment 100415680 Score: 2: </h4>I still don&#39;t get it. Why is it needed?<br><h4> lacostenycoder, Comment 132922106 Score: 1: </h4>Can adding this to legacy codebase break something? What is the likelyhood?<br><h4> Dave Schweisguth, Comment 78505044 Score: 0: </h4><a href="https://github.com/ruby/ruby/blob/trunk/string.c#L2541" rel="nofollow noreferrer"><code>#freeze</code></a> is implemented mostly as it is for all <code>Object</code>s, but unary <code>-</code> is specific to <code>String</code>. But I don&#39;t know why unary <code>-</code> doesn&#39;t just call <code>#freeze</code>.<br><h4> gerry3, Comment 133966471 Score: 0: </h4>is <code>The comment must be on the first line of the file.</code> true? the example here does NOT have it on the first line, so does it not work then? which line should go first in an executable ruby script: freezing string literals or the shebang for executability?<br><h4> Dave Schweisguth, Comment 133967360 Score: 0: </h4>@gerry3 good observation; I corrected my answer. Note however that I&#39;m pretty sure that the Ruby interpreter doesn&#39;t see the hashbang line. The shell should remove it before sending the rest of the file through the executable that it specifies.<br>------------------------------------------------------------------ <br><h3> Tenzin Chemi, Id: 55900180, Score: 220: </h3><p>It improves application performance by not allocating new space for the same string, thereby also saving time for garbage collection chores. How? when you freeze a string literal(string object), you're telling Ruby to not let any of your programs modify the string literal (object).</p>

<p>Some obvious observations to keep in mind.</p>

<h2>1. By freezing string literals, you're not allocating new memory space for it.</h2>

<p>Example:</p>

<p><em><strong>Without magic comment</strong> allocates new space for the same string
(Observe the different object IDs printed)</em></p>

<p></p>

<pre><code>def hello_id
  a = 'hello'
  a.object_id
end

puts hello_id   #=&gt; 70244568358640
puts hello_id   #=&gt; 70244568358500
</code></pre>

<p><em><strong>With magic comment</strong>, ruby allocates space only once</em></p>

<p></p>

<pre><code># frozen_string_literal: true

def hello_id
  a = 'hello'
  a.object_id
end

puts hello_id   #=&gt; 70244568358640
puts hello_id   #=&gt; 70244568358640
</code></pre>

<hr/>

<h2>2. By freezing string literals, your program will raise an exception when trying to modify the string literal.</h2>

<p>Example:</p>

<p><em><strong>Without magic comment</strong></em>, you can modify the string literals.</p>

<p></p>

<pre><code>name = 'Johny'
name &lt;&lt; ' Cash'

puts name     #=&gt; Johny Cash
</code></pre>

<p><em><strong>With magic comment</strong></em>, an exception will be raised when you modify string literals</p>

<p></p>

<pre><code># frozen_string_literal: true

name = 'john'
name &lt;&lt; ' cash'  #=&gt; `&lt;main&gt;': can't modify frozen String (FrozenError)

puts name      
</code></pre>

<p>There's always more to learn and be flexible:</p>

<ul>
<li><a href="https://bugs.ruby-lang.org/issues/8976" rel="noreferrer">https://bugs.ruby-lang.org/issues/8976</a></li>
<li><a href="https://www.mikeperham.com/2018/02/28/ruby-optimization-with-one-magic-comment/" rel="noreferrer">https://www.mikeperham.com/2018/02/28/ruby-optimization-with-one-magic-comment/</a></li>
</ul>
------------------------------------------------------------------ <br><h3> AlexSh, Id: 51634367, Score: 55: </h3><p>In Ruby 3.0. Matz (Rubyâ€™s creator) decided to make all String literals frozen by default.</p>
<p><strong>EDIT 2019</strong>: he decided to abandon the idea of making frozen-string-literals default for Ruby 3.0 (source: <a href="https://bugs.ruby-lang.org/issues/11473#note-53" rel="noreferrer">https://bugs.ruby-lang.org/issues/11473#note-53</a>)</p>
<hr />
<p>You can use in Ruby 2.x. Just add this comment in the first line of your files.</p>
<pre><code># frozen_string_literal: true
</code></pre>
<blockquote>
<p>The above comment at top of a file changes semantics of static string
literals in the file. The static string literals will be frozen and
always returns same object. (The semantics of dynamic string literals
is not changed.)</p>
<p>This way has following benefits:</p>
<p>No ugly f-suffix.
No syntax error on older Ruby.
We need only a line
for each file.</p>
</blockquote>
<p>Plese, read this topic for more information.</p>
<p><a href="https://bugs.ruby-lang.org/issues/8976" rel="noreferrer">https://bugs.ruby-lang.org/issues/8976</a></p>
<h4> Eliot Sykes, Comment 134656504 Score: 2: </h4>@ToTenMilan In Ruby 3.0.6, the frozen_string_literal comment does work for strings in arrays, the strings cannot be modified. What Ruby version did you find this did not work in?<br><h4> ToTenMilan, Comment 96390167 Score: 1: </h4>Unfortunately this comment does not work for strings in arrays, so they still need to be freezed explicitly<br>